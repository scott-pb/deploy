<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>soga 发布系统</title>
    <link rel="stylesheet" href="./layui/css/layui.css"> <!-- 引入layer.js的样式文件 -->
    <style>
        /* 样式定义 */
        #scrollToTopBtn {
            display: none; /* 默认隐藏 */
            position: fixed; /* 固定位置 */
            bottom: 20px; /* 距离底部20px */
            right: 30px; /* 距离右侧30px */
            z-index: 99; /* 确保在其他内容之上 */
            border: none; /* 移除边框 */
            outline: none; /* 移除轮廓线 */
            background-color: #1e9fff; /* 按钮颜色 */
            color: white; /* 文字颜色 */
            cursor: pointer; /* 鼠标悬停样式 */
            padding: 15px; /* 内边距 */
            border-radius: 10px; /* 圆角 */
            font-size: 18px; /* 字体大小 */
        }

        #scrollToTopBtn:hover {
            background-color: #16baaa; /* 鼠标悬停时改变背景色 */
        }
    </style>
</head>
<body>

<div class="layui-btn-container " style="text-align: center;background-color:#16b777;padding-top: 10px">
    <button type="button" class="layui-btn layui-bg-blue" id="connect">连接</button>
    <button type="button" class="layui-btn layui-bg-red" id="disconnect">断开</button>
    <button type="button" class="layui-btn layui-bg-purple" id="clear">清空</button>
    <button type="button" class="layui-btn layui-bg-gray" id="openLoginBtn">登录</button>
    <button type="button" class="layui-btn layui-bg-orange" id="loginOut">登出</button>
</div>

<form class="layui-form" action="" id="form">
    <div class="layui-form-item" id="status" style="text-align: right">
        <span style="color: #ff5722;font-weight: bold;">状态：未连接</span>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">环境</label>
        <div class="layui-input-block">
            <input type="radio" name="env" lay-filter="env-filter" value="test" title="test" checked>
            <input type="radio" name="env" lay-filter="env-filter" value="release" title="release">
            <input type="radio" name="env" lay-filter="env-filter" value="production" title="production">
        </div>
    </div>

    <div class="layui-form-item layui-col-md6" id="project">
        <label class="layui-form-label">项目</label>
        <div class="layui-input-block">
            <select name="project" lay-filter="select-project">
                <option value="admin" selected>admin</option>
                <option value="enterprise">enterprise</option>
                <option value="server">server</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item" id="items" style="display: none">
        <label class="layui-form-label">工程</label>
        <div class="layui-input-block" id="checkItems">

        </div>
    </div>

    <div class="layui-form-item" id="branch">
        <label class="layui-form-label">分支</label>
        <div class="layui-input-inline layui-input-wrap">
            <input type="text" name="branch" lay-verify="required" autocomplete="off" class="layui-input"
                   value="dev">
        </div>
    </div>

    <div class="layui-form-item" id="restart">
        <label class="layui-form-label">重启</label>
        <div class="layui-input-block">
            <input type="radio" name="restart" value="true" title="true" checked>
            <input type="radio" name="restart" value="false" title="false">
        </div>
    </div>
    <div class="layui-form-item">
        <div>
            <button type="submit" id="submit" class="layui-btn layui-btn-fluid" lay-submit lay-filter="submit">提交
            </button>
        </div>
    </div>
</form>
<!-- 悬浮按钮 -->
<button id="scrollToTopBtn" title="Go to top">Top</button>
<pre class="layui-code code-demo" id="messages" lay-options="{}">

</pre>
<div id="bottom"></div>
</body>

<script src="./layui/layui.js"></script> <!-- 引入layer.js文件 -->
<script src="./jquery/jquery.js"></script>
<script type="application/javascript">
    let loginOpen = null;
    let ws = null;
    let heartbeatInterval = null;
    let loadCloseIndex = null;
    let HOST = "{{.host}}";
    let loadIndex = null;
    let loadRunning = null;
    let isRunning = false;
    // 当用户滚动页面超过一定距离时显示按钮，反之则隐藏
    window.onscroll = function () {
        scrollFunction()
    };


    function scrollFunction() {
        let scrollToTopBtn = document.getElementById("scrollToTopBtn");
        if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
            scrollToTopBtn.style.display = "block";
        } else {
            scrollToTopBtn.style.display = "none";
        }
    }

    // 当点击按钮时平滑滚动到顶部
    document.getElementById('scrollToTopBtn').addEventListener('click', function () {
        window.scrollTo({top: 0, behavior: 'smooth'});
    });

    function sendHeartbeat() {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send('ping');
        }
    }

    function startHeartbeat(interval) {
        heartbeatInterval = setInterval(sendHeartbeat, interval || 10000); // 默认间隔10秒
    }

    function stopHeartbeat() {
        clearInterval(heartbeatInterval);
    }

    $("#connect").click(function () {
        if (!window.WebSocket) {
            layer.msg('您的浏览器不支持 WebSocket', {icon: 0});
            return;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
            layer.msg('已经连接到WebSocket服务器', {icon: 0});
            return;
        }

        let token = localStorage.getItem("token");
        if (token === "" || token == null) {
            layer.msg('您还没有登录', {icon: 2});
            return;
        }

        ws = new WebSocket('ws://' + HOST + '/webSocket?' + token);

        ws.onopen = function () {
            document.getElementById('status').innerHTML = '<span style="color: #16b777;font-weight: bold;">状态：连接成功</span>';
            document.getElementById('messages').innerHTML = '';
            startHeartbeat(); // 开始发送心跳
            sendHeartbeat(); // 连接成功后立即发送一次心跳
        };

        ws.onmessage = function (event) {
            let data = event.data
            if (data.length === 0) {
                return
            }
            if (data === "pong") {
                return
            }

            if (data === "no login") {
                document.getElementById('messages').innerHTML = '<span style="color: #ff5722;font-weight: bold; margin: 10% auto">请先登录!</span>';
                ws.close(3008, "noLogin")
                return
            }

            if (data.indexOf("运行中...") !== -1) {
                if (loadIndex == null) {
                    loadIndex = layer.msg(data, {
                        icon: 16,
                        shade: 0.01
                    });
                }
                return;
            }

            if (loadIndex !== null) {
                layer.close(loadIndex)
            }
            if (loadRunning) {
                layer.close(loadRunning);
            }
            isRunning = true
            if (data === "finished") {
                isRunning = false;
                $("#submit").removeClass("layui-btn-disabled")
                return;
            }

            document.getElementById('messages').innerHTML += data + "<br>";
            location.href = '#bottom';
        };

        ws.onerror = function (error) {
            console.log(error)
            isRunning = false
            if (loadRunning) {
                layer.close(loadRunning);
            }
            layer.msg('WebSocket 连接错误', {icon: 0});
        };

        ws.onclose = function (event) {
            layer.close(loadCloseIndex);
            if (loadRunning) {
                layer.close(loadRunning);
            }
            console.log(event.code);
            isRunning = false
            let msg = '';
            if (event.code === 3008) {
                msg = '请先登录';
            } else {
                msg = '连接关闭';
            }
            document.getElementById('status').innerHTML = '<span style="color: #ff5722;font-weight: bold;">状态：' + msg + '</span>';
            ws = null
            stopHeartbeat();
            layer.msg(msg, {icon: 0});
        };
    });

    $("#clear").click(function () {
        document.getElementById('messages').innerHTML = '';
    })

    $('#disconnect').click(function () {
        if (ws && ws.readyState === WebSocket.OPEN) {
            loadCloseIndex = layer.msg('关闭中', {
                icon: 16,
                shade: 0.01
            });
            ws.close();
        } else {
            layer.msg("未连接websocket", {icon: 0});
        }
    });

    layui.form.on('select(select-project)', function (data) {
        let items = [];
        document.getElementById('checkItems').innerHTML = ''
        $("#branch").show();
        $("#restart").show();
        switch (data.value) {
            case "admin":
                $("#items").hide();
                break;
            case "front":
                $("#items").hide();
                $("#branch").hide();
                $("#restart").hide();
                break;
            case "enterprise":
                $("#items").show();
                items = ["soga_api_chat", "soga_api_chatroom", "soga_rpc_chat", "soga_rpc_game", "soga_cron", "soga_tool"];
                break;
            case "server":
                $("#items").show();
                items = ["soga_im_api", "soga_im_msg_gateway", "soga_im_msg_transfer", "soga_im_push",
                    "soga_im_rpc_auth", "soga_im_rpc_cache", "soga_im_rpc_conversation", "soga_im_rpc_friend",
                    "soga_im_rpc_group", "soga_im_rpc_msg", "soga_im_rpc_office", "soga_im_rpc_organization",
                    "soga_im_rpc_user"];
                break;
        }
        for (let i = 0; i < items.length; i++) {
            document.getElementById('checkItems').innerHTML += '<input type="checkbox" name="items[' + i + ']" lay-skin="tag" title="' + items[i] + '" value="' + items[i] + '">';
        }
        layui.form.render();
    });

    layui.form.on('radio(env-filter)', function (data) {
        let env = data.elem.value; // 获得 radio 值
        if (env === "production") {
            $("#restart").hide();
            $("#project").hide();
        } else {
            $("#restart").show();
            $("#project").show();
        }
    });

    // 提交事件
    layui.form.on('submit(submit)', function (data) {
        if (isRunning) {
            layer.msg("正在运行中...", {icon: 2});
            return false;
        }
        if (ws === null || ws.readyState === WebSocket.CLOSED) {
            layer.msg("未连接websocket", {icon: 2});
            return false;
        }


        document.getElementById('messages').innerHTML = '';
        $("#submit").addClass("layui-btn-disabled")
        let field = data.field; // 获取表单字段值
        field.restart = field.restart === "true"
        let itemsArray = [];
        for (let key in field) {
            if (key.match(/items\[\d\]/)) {
                itemsArray.push(field[key])
            }
        }
        field.items = itemsArray

        // 显示填写结果，仅作演示用
        if (field.env === "release") {
            let confirm = layer.confirm('发布release环境确定继续吗?', {
                btn: ['确定', '关闭'] //按钮
            }, function () {
                ws.send(JSON.stringify(field))
                layer.close(confirm)
                loadRunning = layer.load();
            });
        } else {
            ws.send(JSON.stringify(field))
            loadRunning = layer.load();
        }
        return false; // 阻止默认 form 跳转
    });


    // 退出登录
    $("#loginOut").click(function () {
        let token = localStorage.getItem("token");
        if (token == null) {
            layer.msg('您还没有登录', {icon: 0}, function () {
            });
            return;
        }
        let confirm = layer.confirm('确定登出?', {
            btn: ['确定', '关闭'] //按钮
        }, function () {
            localStorage.removeItem("token");
            layer.close(confirm)
            ws.close()
        });
    });


    // 登录弹窗
    $("#openLoginBtn").click(function () {
        let token = localStorage.getItem("token");
        let content = '<form class="layui-form">\n' +
            '    <div class="demo-login-container">\n' +
            '        <div class="layui-form-item">\n' +
            '            <div class="layui-input-wrap">\n' +
            '                <div class="layui-input-prefix">\n' +
            '                    <i class="layui-icon layui-icon-username"></i>\n' +
            '                </div>\n' +
            '                <input type="text" name="username" value="" lay-verify="required" placeholder="用户名" lay-reqtext="请填写用户名" autocomplete="off" class="layui-input" lay-affix="clear">\n' +
            '            </div>\n' +
            '        </div>\n' +
            '        <div class="layui-form-item">\n' +
            '            <div class="layui-input-wrap">\n' +
            '                <div class="layui-input-prefix">\n' +
            '                    <i class="layui-icon layui-icon-password"></i>\n' +
            '                </div>\n' +
            '                <input type="password" name="password" value="" lay-verify="required" placeholder="密   码" lay-reqtext="请填写密码" autocomplete="off" class="layui-input" lay-affix="eye">\n' +
            '            </div>\n' +
            '        </div>\n' +
            '        <div class="layui-form-item">\n' +
            '            <button class="layui-btn layui-btn-fluid" lay-submit lay-filter="login">登录</button>\n' +
            '        </div>\n' +
            '    </div>\n' +
            '</form>'
        if (token != null) {
            layer.confirm('确定重新登录?', {
                btn: ['确定', '关闭'] //按钮
            }, function () {
                loginOpen = layer.open({
                    type: 1, // page 层类型
                    title: '登录',
                    shade: 0.6, // 遮罩透明度
                    shadeClose: true, // 点击遮罩区域，关闭弹层
                    maxmin: true, // 允许全屏最小化
                    anim: 1, // 0-6 的动画形式，-1 不开启
                    content: content
                });
            });
        } else {
            loginOpen = layer.open({
                type: 1, // page 层类型
                title: '登录',
                shade: 0.6, // 遮罩透明度
                shadeClose: true, // 点击遮罩区域，关闭弹层
                maxmin: true, // 允许全屏最小化
                anim: 1, // 0-6 的动画形式，-1 不开启
                content: content
            });
        }
    });

    // 登录提交事件
    layui.form.on('submit(login)', function (data) {
        let field = data.field; // 获取表单字段值
        let loadIndex = layer.msg('登录中', {
            icon: 16,
            shade: 0.01
        });
        $.ajax({
            url: 'http://' + HOST + '/login',
            type: 'POST',
            data: JSON.stringify(field),
            dataType: "json",
            contentType: "application/json",
            success: function (response) {
                if (response.status === 200) {
                    localStorage.setItem("token", response.token)
                    layer.close(loginOpen)
                    $("#connect").click()
                    layer.msg("登录成功")
                } else {
                    layer.alert(response.message)
                }
                layer.close(loadIndex)
            },
            error: function (error) {
                // 错误回调函数，处理请求失败的情况
                console.log(error)
                layer.msg("登录失败")
                layer.close(loadIndex)
            }
        });

        return false; // 阻止默认 form 跳转
    });
</script>
</html>