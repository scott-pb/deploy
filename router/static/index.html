<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>soga 发布系统</title>
    <link rel="stylesheet" href="./layui/css/layui.css"> <!-- 引入layer.js的样式文件 -->
</head>
<body>

<div class="layui-btn-container " style="text-align: center;background-color:#16b777;padding-top: 10px">
    <button type="button" class="layui-btn layui-bg-blue" id="connect">连接</button>
    <button type="button" class="layui-btn layui-bg-red" id="disconnect">断开</button>
    <button type="button" class="layui-btn layui-bg-purple" id="clear">清空</button>
    <button type="button" class="layui-btn layui-bg-gray" id="openLoginBtn">登录</button>
    <button type="button" class="layui-btn layui-bg-orange" id="loginOut">登出</button>
</div>

<form class="layui-form" action="" id="form">
    <div class="layui-form-item" id="status" style="text-align: right">
        <span style="color: #ff5722;font-weight: bold;">状态：未连接</span>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">环境</label>
        <div class="layui-input-block">
            <input type="radio" name="env" value="test" title="test" checked>
            <input type="radio" name="env" value="release" title="release">
        </div>
    </div>

    <div class="layui-form-item layui-col-md6">
        <label class="layui-form-label">项目</label>
        <div class="layui-input-block">
            <select name="project" lay-filter="select-project">
                <option value="admin" selected>admin</option>
                <option value="enterprise">enterprise</option>
                <option value="server">server</option>
            </select>
        </div>
    </div>

    <div class="layui-form-item" id="items" style="display: none">
        <label class="layui-form-label">工程</label>
        <div class="layui-input-block" id="checkItems">

        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">分支</label>
        <div class="layui-input-inline layui-input-wrap">
            <input type="text" name="branch" lay-verify="required" autocomplete="off" class="layui-input"
                   value="dev">
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">重启</label>
        <div class="layui-input-block">
            <input type="radio" name="restart" value="true" title="true" checked>
            <input type="radio" name="restart" value="false" title="false">
        </div>
    </div>
    <div class="layui-form-item">
        <div>
            <button type="submit" class="layui-btn layui-btn-fluid" lay-submit lay-filter="submit">提交</button>
        </div>
    </div>
</form>
<pre class="layui-code code-demo" id="messages" lay-options="{}">

</pre>

</body>

<script src="./layui/layui.js"></script> <!-- 引入layer.js文件 -->
<script src="./jquery/jquery.js"></script>
<script type="application/javascript">
    let loginOpen = null;
    let ws = null;
    let heartbeatInterval = null;
    let loadCloseIndex = null;
    let pingValue = 0;
    let HOST = {{.host}}

    function sendHeartbeat() {
        if (pingValue > 3) {
            if (ws !== null) {
                ws.clone()
            }
            return
        }
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send('ping');
            pingValue += 1
        }
    }

    function startHeartbeat(interval) {
        heartbeatInterval = setInterval(sendHeartbeat, interval || 10000); // 默认间隔10秒
    }

    function stopHeartbeat() {
        clearInterval(heartbeatInterval);
    }

    $("#connect").click(function () {
        if (!window.WebSocket) {
            layer.msg('您的浏览器不支持 WebSocket', {icon: 0});
            return;
        }

        if (ws && ws.readyState === WebSocket.OPEN) {
            layer.msg('已经连接到WebSocket服务器', {icon: 0});
            return;
        }

        let token = localStorage.getItem("token");
        if (token === "" || token == null) {
            layer.msg('您还没有登录', {icon: 2});
            return;
        }

        ws = new WebSocket('ws://' + HOST+'/webSocket?' + token);

        ws.onopen = function () {
            pingValue = 0
            document.getElementById('status').innerHTML = '<span style="color: #16b777;font-weight: bold;">状态：连接成功</span>';
            document.getElementById('messages').innerHTML = '';
            startHeartbeat(); // 开始发送心跳
            sendHeartbeat(); // 连接成功后立即发送一次心跳
        };

        ws.onmessage = function (event) {
            pingValue = 0
            let data = event.data
            if (data.length === 0) {
                return
            }
            if (data === "pong") {
                return
            }

            if (data === "no login") {
                document.getElementById('messages').innerHTML = '<span style="color: #ff5722;font-weight: bold; margin: 10% auto">请先登录!</span>';
                ws.close(3008, "noLogin")
                return
            }
            document.getElementById('messages').innerHTML += data;
        };

        ws.onerror = function (error) {
            pingValue = 0
            console.log(error)
            layer.msg('WebSocket 连接错误', {icon: 0});
        };

        ws.onclose = function (event) {
            pingValue = 0
            layer.close(loadCloseIndex)
            console.log(event.code);
            let msg = '';
            if (event.code === 3008) {
                msg = '请先登录';
            } else {
                msg = '连接关闭';
            }
            document.getElementById('status').innerHTML = '<span style="color: #ff5722;font-weight: bold;">状态：' + msg + '</span>';
            ws = null
            stopHeartbeat();
            layer.msg(msg, {icon: 0});
        };
    });

    $("#clear").click(function () {
        document.getElementById('messages').innerHTML = '';
    })

    $('#disconnect').click(function () {
        if (ws && ws.readyState === WebSocket.OPEN) {
            loadCloseIndex = layer.msg('关闭中', {
                icon: 16,
                shade: 0.01
            });
            ws.close();
        } else {
            layer.msg("未连接websocket", {icon: 0});
        }
    });

    layui.form.on('select(select-project)', function (data) {
        let items = [];
        document.getElementById('checkItems').innerHTML = ''
        switch (data.value) {
            case "admin":
                $("#items").hide();
                break;
            case "enterprise":
                $("#items").show();
                items = ["soga_api_chat", "soga_api_chatroom", "soga_rpc_chat", "soga_rpc_game", "soga_cron", "soga_tool"];
                break;
            case "server":
                $("#items").show();
                items = ["soga_im_api", "soga_im_msg_gateway", "soga_im_msg_transfer", "soga_im_push",
                    "soga_im_rpc_auth", "soga_im_rpc_cache", "soga_im_rpc_conversation", "soga_im_rpc_friend",
                    "soga_im_rpc_group", "soga_im_rpc_msg", "soga_im_rpc_office", "soga_im_rpc_organization",
                    "soga_im_rpc_user"];
                break;
        }
        for (let i = 0; i < items.length; i++) {
            document.getElementById('checkItems').innerHTML += '<input type="checkbox" name="items[' + i + ']" lay-skin="tag" title="' + items[i] + '" value="' + items[i] + '">';
        }
        layui.form.render();
    });

    // 提交事件
    layui.form.on('submit(submit)', function (data) {
        if (ws === null || ws.readyState === WebSocket.CLOSED) {
            layer.msg("未连接websocket", {icon: 2});
            return false;
        }
        let field = data.field; // 获取表单字段值
        field.restart = field.restart === "true"
        // 显示填写结果，仅作演示用
        if (field.env === "release") {
            let confirm = layer.confirm('发布release环境确定继续吗?', {
                btn: ['确定', '关闭'] //按钮
            }, function () {
                ws.send(JSON.stringify(field))
                layer.close(confirm)
            });
        } else {
            ws.send(JSON.stringify(field))
        }
        return false; // 阻止默认 form 跳转
    });


    $("#submit").click(function () {
        let json = $('#form').serialize();
        layer.alert(json);
    });

    $("#loginOut").click(function () {
        let token = localStorage.getItem("token");
        if (token == null) {
            layer.msg('您还没有登录', {icon: 0}, function () {
            });
            return;
        }
        let confirm = layer.confirm('确定登出?', {
            btn: ['确定', '关闭'] //按钮
        }, function () {
            localStorage.removeItem("token");
            layer.close(confirm)
            ws.close()
        });
    });


    $("#openLoginBtn").click(function () {
        let token = localStorage.getItem("token");
        let content = '<form class="layui-form">\n' +
            '    <div class="demo-login-container">\n' +
            '        <div class="layui-form-item">\n' +
            '            <div class="layui-input-wrap">\n' +
            '                <div class="layui-input-prefix">\n' +
            '                    <i class="layui-icon layui-icon-username"></i>\n' +
            '                </div>\n' +
            '                <input type="text" name="username" value="" lay-verify="required" placeholder="用户名" lay-reqtext="请填写用户名" autocomplete="off" class="layui-input" lay-affix="clear">\n' +
            '            </div>\n' +
            '        </div>\n' +
            '        <div class="layui-form-item">\n' +
            '            <div class="layui-input-wrap">\n' +
            '                <div class="layui-input-prefix">\n' +
            '                    <i class="layui-icon layui-icon-password"></i>\n' +
            '                </div>\n' +
            '                <input type="password" name="password" value="" lay-verify="required" placeholder="密   码" lay-reqtext="请填写密码" autocomplete="off" class="layui-input" lay-affix="eye">\n' +
            '            </div>\n' +
            '        </div>\n' +
            '        <div class="layui-form-item">\n' +
            '            <button class="layui-btn layui-btn-fluid" lay-submit lay-filter="login">登录</button>\n' +
            '        </div>\n' +
            '    </div>\n' +
            '</form>'
        if (token != null) {
            layer.confirm('确定重新登录?', {
                btn: ['确定', '关闭'] //按钮
            }, function () {
                loginOpen = layer.open({
                    type: 1, // page 层类型
                    title: '登录',
                    shade: 0.6, // 遮罩透明度
                    shadeClose: true, // 点击遮罩区域，关闭弹层
                    maxmin: true, // 允许全屏最小化
                    anim: 1, // 0-6 的动画形式，-1 不开启
                    content: content
                });
            });
        } else {
            loginOpen = layer.open({
                type: 1, // page 层类型
                title: '登录',
                shade: 0.6, // 遮罩透明度
                shadeClose: true, // 点击遮罩区域，关闭弹层
                maxmin: true, // 允许全屏最小化
                anim: 1, // 0-6 的动画形式，-1 不开启
                content: content
            });
        }
    });

    // 提交事件
    layui.form.on('submit(login)', function (data) {
        let field = data.field; // 获取表单字段值
        let loadIndex = layer.msg('登录中', {
            icon: 16,
            shade: 0.01
        });
        $.ajax({
            url: 'http://' + HOST+'/login',
            type:'POST',
            data:JSON.stringify(field),
            dataType:"json",
            contentType:"application/json",
            success:function (response) {
            if (response.status === 200) {
                localStorage.setItem("token", response.token)
                layer.close(loginOpen)
                $("#connect").click()
                layer.msg("登录成功")
            } else {
                layer.alert(response.message)
            }
            layer.close(loadIndex)
        },
        error: function (error) {
            // 错误回调函数，处理请求失败的情况
            console.log(error)
            layer.msg("登录失败")
            layer.close(loadIndex)
        }
    });

        return false; // 阻止默认 form 跳转
    });
</script>
</html>